@model SummaryReportGenerationViewModel
@using System.Globalization
@using Core.Enums
@{
    ViewData["Title"] = "Генерация сводного отчета";
}

@section Styles {
<style>


    .report-type-tabs .nav-link {
    font-weight: 500;
    color: #495057;
    }

    .report-type-tabs .nav-link.active {
    font-weight: 600;
    color: #0d6efd;
    border-bottom: 2px solid #0d6efd;
    }

    .branches-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 15px;
    }

    .branch-item {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }

    .branch-item:last-child {
        border-bottom: none;
    }
    .form-check-input {
        margin-right: 8px;
    }

</style>
}

<h2 class="mb-4">@ViewData["Title"]</h2>

<form method="post" id="summaryForm">
    <ul class="nav nav-tabs report-type-tabs mb-3" id="reportTypeTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-tab" data-bs-toggle="tab"
            data-bs-target="#all" type="button" role="tab"
            data-report-type="">
                Все отчеты
            </button>
        </li>
        @foreach (var reportType in Enum.GetValues(typeof(ReportType)))
        {
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="@(reportType.ToString().ToLower())-tab"
                data-bs-toggle="tab" data-bs-target="#@(reportType.ToString().ToLower())"
                type="button" role="tab"
                data-report-type="@reportType">
                    @switch (@reportType.ToString())
                    {
                        case "Plan":
                        @Html.Label("Плановый");
                        break;
                        case "Accountant":
                        @Html.Label("Бухгалтерский");
                        break;
                    }
                </button>
            </li>
        }
    </ul>

    <div class="mb-3">
        <label for="templateSelect" class="form-label">Шаблон отчета:</label>
        <select id="templateSelect" name="SelectedTemplateId" class="form-select">
            <option value="">-- Выберите отчет --</option>
            @foreach (var t in Model.Templates)
            {
                <option value="@t.Id"
                        data-period-type="@t.DeadlineType"
                        data-report-type="@t.Type"
                        data-is-special="@(t.Name == "Численность 6-Т для ПЭО" ? "true" : "false")">
                    @t.Name
                </option>
            }
        </select>
    </div>

    <div id="extendedReportOption" class="mb-3 form-check" style="display: none;">
        <input asp-for="IsExtendedReport" class="form-check-input" type="checkbox" id="IsExtendedReport">
        <label class="form-check-label" for="IsExtendedReport">
            Расширенный отчет
        </label>
    </div>
    <div id="rangesConfiguration" class="mb-3" style="display: none;">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <strong>Настройка диапазонов для суммирования (Строки 3-47)</strong>
                <button type="button" class="btn btn-sm btn-light" id="addRangeButton">
                    + Добавить группу
                </button>
            </div>
            <div class="card-body" id="rangesList">
                <p class="text-muted small mb-3">Нажмите "Добавить группу", чтобы определить диапазоны строк (Начало/Конец) для расчета процентов.</p>

            </div>
        </div>
    </div>
    
        <div id="year-group" class="period-group">
            <label for="Year" class="form-label">Год:</label>
            <input asp-for="Year" class="form-control" type="number"
                   min="2000" max="2100" value="@DateTime.Now.Year" />
        </div>

    <div id="month-group" class="period-group">
        <label for="Month" class="form-label">Месяц:</label>
        <select asp-for="Month" class="form-select">
            <option value="">-- Выберите месяц --</option>
            @for (int i = 1; i <= 12; i++)
            {
                <option value="@i">@CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(i)</option>
            }
        </select>
    </div>

    <div id="quarter-group" class="period-group">
        <label for="Quarter" class="form-label">Квартал:</label>
        <select asp-for="Quarter" class="form-select">
            <option value="">-- Выберите квартал --</option>
            <option value="1">Январь-Март</option>
            <option value="2">Январь-Июнь</option>
            <option value="3">Январь-Сентябрь</option>
            <option value="4">Январь-Декабрь</option>
        </select>
    </div>

    <div id="half-group" class="period-group">
        <label for="HalfYearPeriod" class="form-label">Полугодие:</label>
        <select asp-for="HalfYearPeriod" class="form-select">
            <option value="">-- Выберите полугодие --</option>
            <option value="1">Январь-Июнь</option>
            <option value="2">Январь-Декабрь</option>
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Филиалы:</label>
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-medium">Выбрать:</span>
            <div>
                <button type="button" id="selectAllBranches" class="btn btn-sm btn-success me-2">✓ Все</button>
                <button type="button" id="deselectAllBranches" class="btn btn-sm btn-warning">× Сбросить</button>
            </div>
        </div>

        <div class="branches-container" id="branchesListWrapper">

            <div id="branchesContainer">
                <div class="text-muted p-3 text-center">Выберите шаблон и период для загрузки списка филиалов.</div>
            </div>

            <div id="branchesLoader" class="text-primary p-3 text-center" style="display: none;">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                Загрузка доступных филиалов...
            </div>

        </div>
    </div>

    <button type="submit" class="btn btn-primary">Сгенерировать</button>
</form>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- 1. ДАННЫЕ СТРОК (Справочник, строки 3-47) ---
            const rowsData = [
                { id: 3, text: "от 700 до 900 руб." },
                // ... (Остальные 44 строки, id: 4 до 47)
                { id: 4, text: "от 900,1 до 1 000 руб." },
                { id: 5, text: "от 1 000,1 до 1 100 руб." },
                { id: 6, text: "от 1 100,1 до 1 200 руб." },
                { id: 7, text: "от 1 200,1 до 1 300 руб." },
                { id: 8, text: "от 1 300,1 до 1 400 руб." },
                { id: 9, text: "от 1 400,1 до 1 500 руб." },
                { id: 10, text: "от 1 500,1 до 1 600 руб." },
                { id: 11, text: "от 1 600,1 до 1 700 руб." },
                { id: 12, text: "от 1 700,1 до 1 800 руб." },
                { id: 13, text: "от 1 800,1 до 1 900 руб." },
                { id: 14, text: "от 1 900,1 до 2 000 руб." },
                { id: 15, text: "от 2 000,1 до 2 250 руб." },
                { id: 16, text: "от 2 250,1 до 2 500 руб." },
                { id: 17, text: "от 2 500,1 до 2 700 руб." },
                { id: 18, text: "от 2 700,1 до 2 900 руб." },
                { id: 19, text: "от 2 900,1 до 3 100 руб." },
                { id: 20, text: "от 3 100,1 до 3 300 руб." },
                { id: 21, text: "от 3 300,1 до 3 500 руб." },
                { id: 22, text: "от 3 500,1 до 3 700 руб." },
                { id: 23, text: "от 3 700,1 до 3 900 руб." },
                { id: 24, text: "от 3 900,1 до 4 100 руб." },
                { id: 25, text: "от 4 100,1 до 4 300 руб." },
                { id: 26, text: "от 4 300,1 до 4 500 руб." },
                { id: 27, text: "от 4 500,1 до 4 700 руб." },
                { id: 28, text: "от 4 700,1 до 4 900 руб." },
                { id: 29, text: "от 4 900,1 до 5 100 руб." },
                { id: 30, text: "от 5 100,1 до 5 300 руб." },
                { id: 31, text: "от 5 300,1 до 5 500 руб." },
                { id: 32, text: "от 5 500,1 до 5 700 руб." },
                { id: 33, text: "от 5 700,1 до 5 900 руб." },
                { id: 34, text: "от 5 900,1 до 6 100 руб." },
                { id: 35, text: "от 6 100,1 до 6 300 руб." },
                { id: 36, text: "от 6 300,1 до 6 500 руб." },
                { id: 37, text: "от 6 500,1 до 6 700 руб." },
                { id: 38, text: "от 6 700,1 до 6 900 руб." },
                { id: 39, text: "от 6 900,1 до 7 100 руб." },
                { id: 40, text: "от 7 100,1 до 7 300 руб." },
                { id: 41, text: "от 7 300,1 до 7 500 руб." },
                { id: 42, text: "от 7 500,1 до 7 700 руб." },
                { id: 43, text: "от 7 700,1 до 7 900 руб." },
                { id: 44, text: "от 7 900,1 до 8 100 руб." },
                { id: 45, text: "от 8 100,1 до 8 300 руб." },
                { id: 46, text: "от 8 300,1 до 8 500 руб." },
                { id: 47, text: "свыше 8500 руб." }
            ];

            // --- ЭЛЕМЕНТЫ УПРАВЛЕНИЯ ---
            const templateSelect = document.getElementById('templateSelect');
            const extendedOptionGroup = document.getElementById('extendedReportOption');
            const extendedCheckbox = document.getElementById('IsExtendedReport');
            const rangesConfigDiv = document.getElementById('rangesConfiguration');
            const rangesList = document.getElementById('rangesList'); // НОВЫЙ
            const addRangeButton = document.getElementById('addRangeButton'); // НОВЫЙ

            const yearInput = document.querySelector('input[name="Year"]');
            const monthSelect = document.querySelector('select[name="Month"]');
            const quarterSelect = document.querySelector('select[name="Quarter"]');
            const halfYearSelect = document.querySelector('select[name="HalfYearPeriod"]');

            const yearGroup = document.getElementById('year-group');
            const monthGroup = document.getElementById('month-group');
            const quarterGroup = document.getElementById('quarter-group');
            const halfGroup = document.getElementById('half-group');

            const branchesContainer = document.getElementById('branchesContainer');
            const branchesLoader = document.getElementById('branchesLoader');
            const selectAllBtn = document.getElementById('selectAllBranches');
            const deselectAllBtn = document.getElementById('deselectAllBranches');

            // --- ГЛОБАЛЬНЫЙ СЧЕТЧИК ДЛЯ ГРУПП ---
            let groupCounter = 0;

            // --- ФУНКЦИИ ДЛЯ ДИАПАЗОНОВ ---

            // Создает и возвращает HTML для одной группы диапазона
            function createRangeGroupHtml(groupIndex) {
                const groupName = `group_${groupIndex}`;
                return `
                    <div class="range-group mb-3 border-bottom pb-3" data-group-index="${groupIndex}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold text-primary">Группа ${groupIndex}</label>
                            <button type="button" class="btn btn-sm btn-danger remove-range-btn">
                                &times; Удалить
                            </button>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="small">Начальная строка:</label>
                                <select class="form-select form-select-sm range-select"
                                        id="${groupName}_start"
                                        name="SelectedRowIndexes"
                                        data-row-type="start"
                                        required></select>
                            </div>
                            <div class="col-6">
                                <label class="small">Конечная строка:</label>
                                <select class="form-select form-select-sm range-select"
                                        id="${groupName}_end"
                                        name="SelectedRowIndexes"
                                        data-row-type="end"
                                        required></select>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Заполняет Select-ы данными (Строки 3-47)
            function populateRangeSelects(selects) {
                selects.forEach(select => {
                    rowsData.forEach(row => {
                        const option = document.createElement('option');
                        option.value = row.id;
                        option.text = `[Стр. ${row.id}] ${row.text}`;
                        select.appendChild(option);
                    });
                });
            }

            // Добавляет новую группу диапазонов
            function addRangeGroup(defaultStart = 3, defaultEnd = 14) {
                groupCounter++;
                rangesList.insertAdjacentHTML('beforeend', createRangeGroupHtml(groupCounter));

                const newGroup = rangesList.lastElementChild;
                const startSelect = newGroup.querySelector('[data-row-type="start"]');
                const endSelect = newGroup.querySelector('[data-row-type="end"]');

                // Заполняем опциями
                populateRangeSelects([startSelect, endSelect]);

                // Устанавливаем значения по умолчанию
                startSelect.value = defaultStart;
                endSelect.value = defaultEnd;

                // Добавляем обработчик удаления
                newGroup.querySelector('.remove-range-btn').addEventListener('click', function() {
                    newGroup.remove();
                    updateRangesInfo(); // Обновляем информацию, если групп стало 0
                });

                updateRangesInfo();
            }

            // Обновление текста, если нет групп
            function updateRangesInfo() {
                const groups = rangesList.querySelectorAll('.range-group');
                if (groups.length === 0) {
                    rangesList.innerHTML = '<p class="text-muted small mb-3" id="noRangesInfo">Нажмите "Добавить группу", чтобы определить диапазоны строк (Начало/Конец) для расчета процентов.</p>';
                } else {
                    const info = document.getElementById('noRangesInfo');
                    if(info) info.remove();
                }

                // Переименовываем группы по порядку
                groups.forEach((group, index) => {
                    group.querySelector('label.form-label').textContent = `Группа ${index + 1}`;
                });
            }


            // --- ОСНОВНЫЕ ФУНКЦИИ И ИНИЦИАЛИЗАЦИЯ ---

            async function updateAvailableBranches() {
                // ... (Логика updateAvailableBranches остается без изменений)
                const templateId = templateSelect.value;
                if (!templateId) {
                    branchesContainer.innerHTML = '<div class="text-muted p-3 text-center">Выберите шаблон и период для загрузки списка филиалов.</div>';
                    return;
                }

                const year = yearInput.value;
                const month = monthGroup.style.display !== 'none' ? monthSelect.value : '';
                const quarter = quarterGroup.style.display !== 'none' ? quarterSelect.value : '';
                const halfYear = halfGroup.style.display !== 'none' ? halfYearSelect.value : '';

                branchesLoader.style.display = 'block';
                branchesContainer.style.display = 'none';

                const url = `/ReportMvc/GetBranchesWithAcceptedReports?templateId=${templateId}&year=${year}&month=${month}&quarter=${quarter}&halfYear=${halfYear}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Ошибка сети');
                    const branches = await response.json();

                    branchesContainer.innerHTML = '';
                    if (branches.length > 0) {
                        branches.forEach(branch => {
                            const branchHtml = `
                                <div class="branch-item">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="branch_${branch.id}"
                                                name="SelectedBranchIds" value="${branch.id}">
                                        <label class="form-check-label" for="branch_${branch.id}">${branch.name}</label>
                                    </div>
                                </div>`;
                            branchesContainer.insertAdjacentHTML('beforeend', branchHtml);
                        });
                    } else {
                        branchesContainer.innerHTML = '<div class="text-muted p-3 text-center">Нет филиалов с принятыми отчетами по заданным параметрам.</div>';
                    }
                } catch (error) {
                    console.error(error);
                    branchesContainer.innerHTML = '<div class="text-danger p-3 text-center">Не удалось загрузить список.</div>';
                } finally {
                    branchesLoader.style.display = 'none';
                    branchesContainer.style.display = 'block';
                }
            }

            const reportTypeTabs = document.querySelectorAll('#reportTypeTabs .nav-link');

            function filterTemplatesByType(reportType) {
                // ... (Логика filterTemplatesByType остается без изменений)
                const options = templateSelect.querySelectorAll('option');
                options.forEach(option => {
                    if (option.value === "") { option.style.display = 'block'; return; }
                    const type = option.getAttribute('data-report-type');
                    option.style.display = (!reportType || type === reportType) ? 'block' : 'none';
                });
                if (templateSelect.selectedIndex !== 0 && templateSelect.options[templateSelect.selectedIndex].style.display === 'none') {
                    templateSelect.selectedIndex = 0;
                }
            }

            function updateFormVisibility() {
                const selectedOption = templateSelect.selectedOptions[0];
                const periodType = selectedOption ? selectedOption.getAttribute('data-period-type') : null;
                // Читаем, является ли выбранный шаблон "особенным"
                const isSpecialReport = selectedOption ? selectedOption.getAttribute('data-is-special') === 'true' : false;

                // 1. Периоды
                document.querySelectorAll('.period-group').forEach(group => group.style.display = 'none');
                if (periodType) {
                    yearGroup.style.display = 'block';
                    switch(periodType) {
                        case 'Monthly': monthGroup.style.display = 'block'; break;
                        case 'Quarterly': quarterGroup.style.display = 'block'; break;
                        case 'HalfYearly': halfGroup.style.display = 'block'; break;
                    }
                }

                // 2. Чекбокс "Расширенный отчет"
                if (isSpecialReport) {
                    extendedOptionGroup.style.display = 'block';
                } else {
                    extendedOptionGroup.style.display = 'none';
                    extendedCheckbox.checked = false;
                }

                // 3. Блок выбора диапазонов
                if (isSpecialReport) {
                    rangesConfigDiv.style.display = 'block';
                } else {
                    rangesConfigDiv.style.display = 'none';
                }
            }

            // --- СОБЫТИЯ ---

            // Обработчик кнопки добавления диапазона
            addRangeButton.addEventListener('click', () => {
                // Устанавливаем разумные значения по умолчанию для первой группы
                const groupsCount = rangesList.querySelectorAll('.range-group').length;
                let defaultStart = 3;
                let defaultEnd = 14;

                // Если групп нет, используем стандартные 3-14
                if (groupsCount === 0) {
                    defaultStart = 3;
                    defaultEnd = 14;
                } else {
                    // Если группы есть, пытаемся определить конец последней группы и начать следующую оттуда
                    const lastEndSelect = rangesList.querySelector(`.range-group:last-child [data-row-type="end"]`);
                    if (lastEndSelect) {
                        const lastEnd = parseInt(lastEndSelect.value);
                        // Начинаем следующую группу на 1 строку ниже конца предыдущей
                        defaultStart = lastEnd + 1;
                        // Ограничиваем старт строкой 47
                        if (defaultStart > 47) defaultStart = 47;

                        // Конец по умолчанию ставим на 47, если старт не 47
                        defaultEnd = defaultStart < 47 ? 47 : 47;
                    }
                }

                addRangeGroup(defaultStart, defaultEnd);
            });

            reportTypeTabs.forEach(tab => {
                // ... (Обработчик клика по вкладкам остается без изменений)
                tab.addEventListener('click', function() {
                    const reportType = this.getAttribute('data-report-type');
                    filterTemplatesByType(reportType);
                    templateSelect.value = '';
                    monthSelect.value = '';
                    quarterSelect.value = '';
                    halfYearSelect.value = '';
                    updateFormVisibility();
                    updateAvailableBranches();
                });
            });

            templateSelect.addEventListener('change', () => {
                // ... (Обработчик изменения шаблона остается без изменений)
                monthSelect.value = '';
                quarterSelect.value = '';
                halfYearSelect.value = '';
                updateFormVisibility();
                updateAvailableBranches();
            });

            // Обработчик чекбокса "Расширенный" - показывает/скрывает диапазоны
            extendedCheckbox.addEventListener('change', () => {
                updateFormVisibility();
            });

            yearInput.addEventListener('change', updateAvailableBranches);
            monthSelect.addEventListener('change', updateAvailableBranches);
            quarterSelect.addEventListener('change', updateAvailableBranches);
            halfYearSelect.addEventListener('change', updateAvailableBranches);

            selectAllBtn.addEventListener('click', function() {
                // ... (Обработчики филиалов остаются без изменений)
                document.querySelectorAll('#branchesContainer input[name="SelectedBranchIds"]').forEach(checkbox => checkbox.checked = true);
            });

            deselectAllBtn.addEventListener('click', function() {
                // ... (Обработчики филиалов остаются без изменений)
                document.querySelectorAll('#branchesContainer input[name="SelectedBranchIds"]').forEach(checkbox => checkbox.checked = false);
            });

            // Валидация при отправке
            document.getElementById('summaryForm').addEventListener('submit', function (e) {
                const templateId = templateSelect.value;

                // 1. Проверка выбранного шаблона
                if (!templateId) {
                    e.preventDefault();
                    alert('Пожалуйста, выберите Шаблон отчета.');
                    return;
                }

                // 2. Проверка обязательных полей периода (только если они видимы)
                // ... (Проверка периодов остается без изменений)
                if (monthGroup.style.display !== 'none' && !monthSelect.value) {
                    e.preventDefault();
                    alert('Пожалуйста, выберите Месяц для данного отчета.');
                    return;
                }
                if (quarterGroup.style.display !== 'none' && !quarterSelect.value) {
                    e.preventDefault();
                    alert('Пожалуйста, выберите Квартал для данного отчета.');
                    return;
                }
                if (halfGroup.style.display !== 'none' && !halfYearSelect.value) {
                    e.preventDefault();
                    alert('Пожалуйста, выберите Полугодие для данного отчета.');
                    return;
                }

                // 3. Проверка выбора хотя бы одного филиала
                const selectedBranches = document.querySelectorAll('#branchesContainer input[name="SelectedBranchIds"]:checked');
                if (selectedBranches.length === 0) {
                    e.preventDefault();
                    alert('Пожалуйста, выберите хотя бы один Филиал.');
                    return;
                }

                // 4. Динамическая валидация диапазонов
                if (rangesConfigDiv.style.display !== 'none') {
                    const rangeGroups = rangesList.querySelectorAll('.range-group');
                    if (rangeGroups.length === 0) {
                        e.preventDefault();
                        alert('Пожалуйста, добавьте хотя бы одну группу диапазонов для расчета процентов.');
                        return;
                    }

                    let rangeValid = true;
                    rangeGroups.forEach((group, index) => {
                        const startRow = parseInt(group.querySelector('[data-row-type="start"]').value);
                        const endRow = parseInt(group.querySelector('[data-row-type="end"]').value);
                        const groupName = `Группа ${index + 1}`;

                        if (startRow >= endRow) {
                            e.preventDefault();
                            alert(`Ошибка в диапазоне: Начальная строка ${groupName} (${startRow}) должна быть строго меньше конечной (${endRow}).`);
                            rangeValid = false;
                        }
                    });

                    if (!rangeValid) return;

                    // Дополнительная проверка на перекрытие (опционально, но рекомендуется)
                    // ... можно добавить логику проверки на перекрытие диапазонов ...
                }
            });

            // Инициализация при загрузке страницы:
            // Вместо initRangeSelectors() вызываем функции управления группами
            addRangeGroup(3, 14); // Группа 1
            addRangeGroup(15, 21); // Группа 2
            addRangeGroup(22, 47); // Группа 3

            const initialReportType = document.querySelector('#reportTypeTabs .nav-link.active').getAttribute('data-report-type');
            filterTemplatesByType(initialReportType || '');
            updateFormVisibility();
            updateAvailableBranches();
        });
    </script>
}