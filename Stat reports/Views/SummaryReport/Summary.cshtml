@model SummaryReportGenerationViewModel
@using System.Globalization
@using Core.Enums
@{
    ViewData["Title"] = "Генерация сводного отчета";
}

@section Styles {
<style>


    .report-type-tabs .nav-link {
    font-weight: 500;
    color: #495057;
    }

    .report-type-tabs .nav-link.active {
    font-weight: 600;
    color: #0d6efd;
    border-bottom: 2px solid #0d6efd;
    }

    .branches-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 15px;
    }

    .branch-item {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }

    .branch-item:last-child {
        border-bottom: none;
    }
    .form-check-input {
        margin-right: 8px;
    }

</style>
}

<h2 class="mb-4">@ViewData["Title"]</h2>

<form method="post" id="summaryForm">
    <ul class="nav nav-tabs report-type-tabs mb-3" id="reportTypeTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-tab" data-bs-toggle="tab"
            data-bs-target="#all" type="button" role="tab"
            data-report-type="">
                Все отчеты
            </button>
        </li>
        @foreach (var reportType in Enum.GetValues(typeof(ReportType)))
        {
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="@(reportType.ToString().ToLower())-tab"
                data-bs-toggle="tab" data-bs-target="#@(reportType.ToString().ToLower())"
                type="button" role="tab"
                data-report-type="@reportType">
                    @switch (@reportType.ToString())
                    {
                        case "Plan":
                        @Html.Label("Плановый");
                        break;
                        case "Accountant":
                        @Html.Label("Бухгалтерский");
                        break;
                    }
                </button>
            </li>
        }
    </ul>

    <div class="mb-3">
        <label for="templateSelect" class="form-label">Шаблон отчета:</label>
        <select id="templateSelect" name="SelectedTemplateId" class="form-select">
            <option value="">-- Выберите отчет --</option>
            @foreach (var t in Model.Templates)
            {
                <option value="@t.Id"
                        data-period-type="@t.DeadlineType"
                        data-report-type="@t.Type"
                        data-is-special="@(t.Id == 9 ? "true" : "false")">
                    @t.Name
                </option>
            }
        </select>
    </div>

    <div id="extendedReportOption" class="mb-3 form-check" style="display: none;">
        <input asp-for="IsExtendedReport" class="form-check-input" type="checkbox" id="IsExtendedReport">
        <label class="form-check-label" for="IsExtendedReport">
            Расширенный отчет
        </label>
    </div>

    
        <div id="year-group" class="period-group">
            <label for="Year" class="form-label">Год:</label>
            <input asp-for="Year" class="form-control" type="number"
                   min="2000" max="2100" value="@DateTime.Now.Year" />
        </div>

    <div id="month-group" class="period-group">
        <label for="Month" class="form-label">Месяц:</label>
        <select asp-for="Month" class="form-select">
            <option value="">-- Выберите месяц --</option>
            @for (int i = 1; i <= 12; i++)
            {
                <option value="@i">@CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(i)</option>
            }
        </select>
    </div>

    <div id="quarter-group" class="period-group">
        <label for="Quarter" class="form-label">Квартал:</label>
        <select asp-for="Quarter" class="form-select">
            <option value="">-- Выберите квартал --</option>
            <option value="1">Январь-Март</option>
            <option value="2">Январь-Июнь</option>
            <option value="3">Январь-Сентябрь</option>
            <option value="4">Январь-Декабрь</option>
        </select>
    </div>

    <div id="half-group" class="period-group">
        <label for="HalfYearPeriod" class="form-label">Полугодие:</label>
        <select asp-for="HalfYearPeriod" class="form-select">
            <option value="">-- Выберите полугодие --</option>
            <option value="1">Январь-Июнь</option>
            <option value="2">Январь-Декабрь</option>
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Филиалы:</label>
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-medium">Выбрать:</span>
            <div>
                <button type="button" id="selectAllBranches" class="btn btn-sm btn-success me-2">✓ Все</button>
                <button type="button" id="deselectAllBranches" class="btn btn-sm btn-warning">× Сбросить</button>
            </div>
        </div>

        <div class="branches-container" id="branchesListWrapper">

            <div id="branchesContainer">
                <div class="text-muted p-3 text-center">Выберите шаблон и период для загрузки списка филиалов.</div>
            </div>

            <div id="branchesLoader" class="text-primary p-3 text-center" style="display: none;">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                Загрузка доступных филиалов...
            </div>

        </div>
    </div>

    <button type="submit" class="btn btn-primary">Сгенерировать</button>
</form>

@section Scripts {
    <script>
        // Используем константу для ID специального отчета.
        // В идеале, это значение должно приходить из Razor (например, @ViewBag.FixedStructureTemplateId).
        // Для примера используем 9.
        const FIXED_REPORT_ID = '9';

        document.addEventListener('DOMContentLoaded', function() {
            // --- Элементы управления ---
            const templateSelect = document.getElementById('templateSelect');
            // !!! ДОБАВЛЕН ЭЛЕМЕНТ !!!
            const extendedOptionGroup = document.getElementById('extendedReportOption');
            const extendedCheckbox = document.getElementById('IsExtendedReport');

            const yearInput = document.querySelector('input[name="Year"]');
            const monthSelect = document.querySelector('select[name="Month"]');
            const quarterSelect = document.querySelector('select[name="Quarter"]');
            const halfYearSelect = document.querySelector('select[name="HalfYearPeriod"]');

            const yearGroup = document.getElementById('year-group');
            const monthGroup = document.getElementById('month-group');
            const quarterGroup = document.getElementById('quarter-group');
            const halfGroup = document.getElementById('half-group');

            const branchesContainer = document.getElementById('branchesContainer');
            const branchesLoader = document.getElementById('branchesLoader');
            const selectAllBtn = document.getElementById('selectAllBranches');
            const deselectAllBtn = document.getElementById('deselectAllBranches');

            // --- Функция для обновления списка филиалов ---
            async function updateAvailableBranches() {
                const templateId = templateSelect.value;

                if (!templateId) {
                    branchesContainer.innerHTML = '<div class="text-muted p-3 text-center">Выберите шаблон и период для загрузки списка филиалов.</div>';
                    return;
                }

                // ВНИМАНИЕ: Если поля скрыты, их .value может быть пустым, что и требуется.
                const year = yearInput.value;
                const month = monthGroup.style.display !== 'none' ? monthSelect.value : '';
                const quarter = quarterGroup.style.display !== 'none' ? quarterSelect.value : '';
                const halfYear = halfGroup.style.display !== 'none' ? halfYearSelect.value : '';

                // Показываем лоадер, скрываем контейнер
                branchesLoader.style.display = 'block';
                branchesContainer.style.display = 'none';

                // NOTE: Нам не нужно передавать IsExtendedReport в GetBranchesWithAcceptedReports,
                // так как это влияет только на генерацию конечного отчета, а не на доступность филиалов.
                const url = `/ReportMvc/GetBranchesWithAcceptedReports?templateId=${templateId}&year=${year}&month=${month}&quarter=${quarter}&halfYear=${halfYear}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error('Ошибка сети при загрузке филиалов.');
                    }
                    const branches = await response.json();

                    // Очищаем и заполняем контейнер новыми данными
                    branchesContainer.innerHTML = '';
                    if (branches.length > 0) {
                        branches.forEach(branch => {
                            const branchHtml = `
                                <div class="branch-item">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="branch_${branch.id}"
                                                name="SelectedBranchIds" value="${branch.id}">
                                        <label class="form-check-label" for="branch_${branch.id}">${branch.name}</label>
                                    </div>
                                </div>`;
                            branchesContainer.insertAdjacentHTML('beforeend', branchHtml);
                        });
                    } else {
                        branchesContainer.innerHTML = '<div class="text-muted p-3 text-center">Нет филиалов с принятыми отчетами по заданным параметрам.</div>';
                    }
                } catch (error) {
                    console.error(error);
                    branchesContainer.innerHTML = '<div class="text-danger p-3 text-center">Не удалось загрузить список филиалов.</div>';
                } finally {
                    // Скрываем лоадер, показываем контейнер
                    branchesLoader.style.display = 'none';
                    branchesContainer.style.display = 'block';
                }
            }

            // --- Логика для управления UI (фильтрация шаблонов) ---
            const reportTypeTabs = document.querySelectorAll('#reportTypeTabs .nav-link');

            function filterTemplatesByType(reportType) {
                const options = templateSelect.querySelectorAll('option');
                options.forEach(option => {
                    if (option.value === "") { option.style.display = 'block'; return; }
                    const type = option.getAttribute('data-report-type');
                    option.style.display = (!reportType || type === reportType) ? 'block' : 'none';
                });
                if (templateSelect.selectedIndex !== 0 && templateSelect.options[templateSelect.selectedIndex].style.display === 'none') {
                    templateSelect.selectedIndex = 0;
                }
            }

            // --- Функция для обновления видимости полей периода и чекбокса ---
            function updateFormVisibility() {
                const selectedOption = templateSelect.selectedOptions[0];
                const periodType = selectedOption ? selectedOption.getAttribute('data-period-type') : null;
                // Читаем, является ли выбранный шаблон "особенным" (fixed ID)
                const isSpecialReport = selectedOption ? selectedOption.getAttribute('data-is-special') === 'true' : false;

                // 1. Управление видимостью полей периода
                yearGroup.style.display = 'none';
                monthGroup.style.display = 'none';
                quarterGroup.style.display = 'none';
                halfGroup.style.display = 'none';

                if (periodType) {
                    yearGroup.style.display = 'block';
                    switch(periodType) {
                        case 'Monthly': monthGroup.style.display = 'block'; break;
                        case 'Quarterly': quarterGroup.style.display = 'block'; break;
                        case 'HalfYearly': halfGroup.style.display = 'block'; break;
                    }
                }

                // 2. Управление видимостью чекбокса "Расширенный отчет"
                if (isSpecialReport) {
                    extendedOptionGroup.style.display = 'block';
                } else {
                    extendedOptionGroup.style.display = 'none';
                    extendedCheckbox.checked = false; // Сбросить значение, если скрываем
                }
            }

            // --- Назначение обработчиков событий ---
            reportTypeTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const reportType = this.getAttribute('data-report-type');
                    filterTemplatesByType(reportType);

                    // Сбросить шаблон и обновить поля
                    templateSelect.value = '';

                    // Сброс значений периода при смене вкладки
                    monthSelect.value = '';
                    quarterSelect.value = '';
                    halfYearSelect.value = '';

                    updateFormVisibility(); // Обновляем видимость полей и чекбокса
                    updateAvailableBranches(); // Обновить филиалы
                });
            });

            // Главный обработчик, который вызывается при смене шаблона
            templateSelect.addEventListener('change', () => {
                // Сброс значений периода при смене шаблона
                monthSelect.value = '';
                quarterSelect.value = '';
                halfYearSelect.value = '';

                updateFormVisibility(); // Обновляем видимость полей и чекбокса
                updateAvailableBranches();
            });

            // Обработчики, которые вызывают обновление списка филиалов
            yearInput.addEventListener('change', updateAvailableBranches);
            monthSelect.addEventListener('change', updateAvailableBranches);
            quarterSelect.addEventListener('change', updateAvailableBranches);
            halfYearSelect.addEventListener('change', updateAvailableBranches);

            // --- Кнопки выбора ---
            selectAllBtn.addEventListener('click', function() {
                document.querySelectorAll('#branchesContainer input[name="SelectedBranchIds"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
            });

            deselectAllBtn.addEventListener('click', function() {
                document.querySelectorAll('#branchesContainer input[name="SelectedBranchIds"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            });

            // --- Обработчик отправки формы с клиентской валидацией ---
            document.getElementById('summaryForm').addEventListener('submit', function (e) {
                const templateId = templateSelect.value;

                // 1. Проверка выбранного шаблона
                if (!templateId) {
                    e.preventDefault();
                    alert('Пожалуйста, выберите Шаблон отчета.');
                    return;
                }

                // 2. Проверка обязательных полей периода (только если они видимы)

                // Monthly check
                if (monthGroup.style.display !== 'none' && !monthSelect.value) {
                    e.preventDefault();
                    alert('Пожалуйста, выберите Месяц для данного отчета.');
                    return;
                }

                // Quarterly check
                if (quarterGroup.style.display !== 'none' && !quarterSelect.value) {
                    e.preventDefault();
                    alert('Пожалуйста, выберите Квартал для данного отчета.');
                    return;
                }

                // HalfYearly check
                if (halfGroup.style.display !== 'none' && !halfYearSelect.value) {
                    e.preventDefault();
                    alert('Пожалуйста, выберите Полугодие для данного отчета.');
                    return;
                }

                // (Опционально) 3. Проверка выбора хотя бы одного филиала
                const selectedBranches = document.querySelectorAll('#branchesContainer input[name="SelectedBranchIds"]:checked');
                if (selectedBranches.length === 0) {
                    e.preventDefault();
                    alert('Пожалуйста, выберите хотя бы один Филиал.');
                    return;
                }

                // Если все проверки пройдены, форма отправляется.
                // Значение IsExtendedReport будет автоматически передано, так как input находится в форме.
            });

            // --- Первоначальная инициализация ---
            const initialReportType = document.querySelector('#reportTypeTabs .nav-link.active').getAttribute('data-report-type');
            filterTemplatesByType(initialReportType || '');
            updateFormVisibility();
            updateAvailableBranches(); // Вызываем один раз при загрузке, чтобы показать начальное сообщение
        });
    </script>
}